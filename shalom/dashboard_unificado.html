<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Escolar Premium</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* ===== BODY & TITULO ===== */
body { font-family: Arial, sans-serif; margin:0; background:#f0f4f8; font-size:13px; }
h1 { text-align:center; padding:12px 0; font-size:22px; color:#333; margin:0; }

/* ===== TABS ===== */
.tabs { display:flex; justify-content:center; flex-wrap:wrap; margin-bottom:8px; gap:6px; }
.tab { padding:6px 14px; cursor:pointer; background:#ddd; border-radius:8px 8px 0 0; font-weight:bold; font-size:13px; transition:.3s; white-space:nowrap; }
.tab.active { background:#4a90e2; color:white; }

/* ===== CONTENIDO DE TAB ===== */
.tab-content { display:none; padding:10px; }
.tab-content.active { display:block; }

/* ===== KPI ===== */
.kpi { display:flex; flex-wrap:wrap; justify-content:space-around; gap:8px; margin:10px 0; }
.kpi div { background:#fff; padding:10px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; flex:1 1 130px; min-width:120px; font-size:13px; transition:.3s; }
.kpi h2 { font-size:16px; margin:4px 0; color:#333; }

/* ===== GRÁFICOS ===== */
.graph-row { display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px; margin-bottom:8px; }
canvas { background:#fff; border-radius:10px; padding:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); flex:1 1 48%; min-width:220px; height:200px; display:block; }

/* ===== TABLAS ===== */
.table-wrapper { overflow-x:auto; }
table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 1px 4px rgba(0,0,0,0.1); margin-top:8px; font-size:12px; min-width:600px; }
th, td { padding:5px; text-align:center; border-bottom:1px solid #eee; }
th { background:#4a90e2; color:white; font-size:12px; }

/* ===== SELECT ===== */
select { padding:5px 8px; border-radius:6px; border:1px solid #ccc; margin-bottom:10px; font-size:13px; width:90%; max-width:280px; display:block; margin-left:auto; margin-right:auto; }

/* ===== ALERTAS ===== */
.alert-zone { margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; justify-content:center; }
.alert { flex:1 1 110px; padding:8px; border-radius:6px; color:white; font-size:11px; box-shadow:0 1px 4px rgba(0,0,0,0.1); text-align:center; transition:.3s; }
.alert.high { background:#e74c3c; }
.alert.medium { background:#f1c40f; color:#333; }
.alert.low { background:#2ecc71; }

/* ===== RESPONSIVE ===== */
@media (max-width:1200px){
  .graph-row { flex-wrap:wrap; gap:8px; }
  canvas { flex:1 1 48%; min-width:200px; height:180px; }
  .kpi div { flex:1 1 110px; min-width:100px; font-size:12px; }
}

@media (max-width:900px){
  .graph-row { flex-direction:column; gap:10px; }
  canvas { flex:1 1 100%; min-width:100%; height:160px; }
  .kpi { flex-direction:column; align-items:center; }
  .kpi div { flex:1 1 95%; max-width:250px; margin-bottom:6px; }
  table { font-size:11px; min-width:0; }
  th, td { padding:4px; }
  .alert { font-size:10px; flex:1 1 90px; }
}
</style>
</head>
<body>

<h1>Dashboard Escolar Premium</h1>

<div class="tabs">
  <div class="tab active" data-tab="bdi">Depresión (BDI)</div>
  <div class="tab" data-tab="bai">Ansiedad (BAI)</div>
</div>

<div style="text-align:center;">
  <label>Filtrar por Grado/Grupo: </label>
  <select id="filtroGrupo">
    <option value="Todos">Todos</option>
  </select>
</div>

<!-- BDI -->
<div class="tab-content active" id="bdi">
  <div class="kpi">
    <div><h2 id="totalEncuestasBDI">0</h2><p>Total de encuestas</p></div>
    <div><h2 id="promedioPuntajeBDI">0</h2><p>Puntaje promedio</p></div>
  </div>
  <div class="graph-row">
    <canvas id="graficoRangosBDI"></canvas>
    <canvas id="graficoItemsBDI"></canvas>
  </div>
  <div class="table-wrapper">
    <table id="tablaResumenBDI">
      <thead>
        <tr>
          <th>Grado/Grupo</th>
          <th>Alumnos</th>
          <th>Puntaje promedio</th>
          <th>Mínimo</th>
          <th>Leve</th>
          <th>Moderado</th>
          <th>Grave</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="alert-zone" id="alertBDI"></div>
</div>

<!-- BAI -->
<div class="tab-content" id="bai">
  <div class="kpi">
    <div><h2 id="totalEncuestasBAI">0</h2><p>Total de encuestas</p></div>
    <div><h2 id="promedioPuntajeBAI">0</h2><p>Puntaje promedio</p></div>
  </div>
  <div class="graph-row">
    <canvas id="graficoNivelesBAI"></canvas>
    <canvas id="graficoItemsBAI"></canvas>
  </div>
  <div class="table-wrapper">
    <table id="tablaResumenBAI">
      <thead>
        <tr>
          <th>Grado/Grupo</th>
          <th>Alumnos</th>
          <th>Puntaje promedio</th>
          <th colspan="4">Rangos</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="alert-zone" id="alertBAI"></div>
</div>

<script>
// === CONFIG ===
const SHEET_ID = '18OWcwGddwymRwmCVDa-MtN3iuFd5ST9o9s5Us3hMtzk';
const HOJAS = { BDI: 'Respuestas_BDI', BAI: 'Respuestas_BAI' };

let dataBDI = [], dataBAI = [];

// === TABS ===
document.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
    document.getElementById(tab.dataset.tab).classList.add('active');
  });
});

// === FILTRO ===
document.getElementById('filtroGrupo').addEventListener('change', ()=>{
  const g = document.getElementById('filtroGrupo').value;
  renderBDI(g); renderBAI(g);
});

// === OBTENER DATOS ===
async function obtenerDatos(hoja){
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${hoja}`;
  const resp = await fetch(url);
  const text = await resp.text();
  const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}')+1));
  const rows = json.table.rows.map(r=>{
    const obj = {};
    json.table.cols.forEach((col,i)=>{
      const cell = r.c[i];
      obj[col.label] = (cell && cell.v != null) ? cell.v : 0;
    });
    return obj;
  });
  return rows;
}

// === INIT ===
async function init(){
  dataBDI = await obtenerDatos(HOJAS.BDI);
  dataBAI = await obtenerDatos(HOJAS.BAI);

  const gruposSet = new Set(dataBDI.map(d=>d['grado_grupo']).concat(dataBAI.map(d=>d['grado_grupo'])));
  gruposSet.forEach(g=>{
    const opt = document.createElement('option'); opt.value=g; opt.textContent=g;
    document.getElementById('filtroGrupo').appendChild(opt);
  });

  renderBDI(); renderBAI();
}

init();

// === GRÁFICOS ===
const graficoRangosBDI = new Chart(document.getElementById('graficoRangosBDI'), {
  type:'bar', data:{labels:['Mínimo','Leve','Moderado','Grave'], datasets:[{label:'Alumnos', data:[0,0,0,0], backgroundColor:['#2ecc71','#f1c40f','#e67e22','#e74c3c']}]}, options:{responsive:true, plugins:{legend:{display:false}}, maintainAspectRatio:false}
});
const graficoItemsBDI = new Chart(document.getElementById('graficoItemsBDI'), {
  type:'radar', data:{labels:[], datasets:[{label:'Promedio por ítem', data:[], backgroundColor:'rgba(46,204,113,0.2)', borderColor:'#2ecc71', pointBackgroundColor:'#27ae60'}]}, options:{responsive:true, scales:{r:{beginAtZero:true}}, maintainAspectRatio:false}
});
const graficoNivelesBAI = new Chart(document.getElementById('graficoNivelesBAI'), {type:'bar', data:{labels:[], datasets:[{label:'Alumnos', data:[], backgroundColor:[]}]} , options:{responsive:true, plugins:{legend:{display:false}}, maintainAspectRatio:false}});
const graficoItemsBAI = new Chart(document.getElementById('graficoItemsBAI'), {type:'radar', data:{labels:[], datasets:[{label:'Promedio por ítem', data:[], backgroundColor:'rgba(52,152,219,0.2)', borderColor:'#3498db', pointBackgroundColor:'#2980b9'}]}, options:{responsive:true, scales:{r:{beginAtZero:true}}, maintainAspectRatio:false}});

// === FUNCIONES RENDER BDI / BAI ===
// Mismo código de renderBDI y renderBAI que ya tenías (funcional, sin cambios de lógica)
</script>
</body>
</html>
